<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AskME ‚Äî –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤.">
    <title>AskME –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="gradient-background">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm animate-fadeIn">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="AskME" width="40" height="40" class="me-2">
            <span class="fw-bold">AskME</span>
        </a>
    </div>
</nav>

<div class="container py-5 animate-slideUp">
    <div class="text-center mb-5">
        <h1 class="title">üîç AskMe –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</h1>
        <p class="subtitle">–ë—ã—Å—Ç—Ä–∞—è –ø–æ–º–æ—â—å –≤ –≤—ã–±–æ—Ä–µ —Ç–æ–≤–∞—Ä–æ–≤</p>
    </div>

    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
    <form method="POST" action="/">
        <div class="mb-4">
            <input type="text" id="product_name" name="product_name" class="form-control form-control-lg"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." value="{{ product_name }}" autocomplete="off" required>
            <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è -->
            <div id="autocomplete-dropdown" class="autocomplete-dropdown list-group" style="display:none;"></div>
        </div>

        <div class="mb-4 d-flex justify-content-center">
            <button type="button" onclick="startRecognition()" class="btn btn-lg btn-secondary" id="voiceButton">
                üéô –ì–æ–≤–æ—Ä–∏—Ç—å
            </button>
        </div>

        <div class="mb-4">
            <select id="product_select" class="form-select form-select-lg"
                    onchange="document.getElementById('product_name').value = this.value;">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã --</option>
                {% for product in products %}
                    <option value="{{ product['name'] }}">{{ product['name'] }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="d-grid">
            <button class="btn btn-primary btn-lg" type="submit">üîé –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</button>
        </div>
    </form>

    <!-- –í—ã–≤–æ–¥ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ -->
    {% if matches %}
    <div class="mt-5">
        {% if matches|length > 1 %}
            <h4 class="mb-3 text-white">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</h4>
            <form method="POST" action="/ask_more">
                <div class="list-group">
                    {% for item in matches %}
                        <label class="list-group-item list-group-item-action bg-light shadow-sm rounded mb-3">
                            <input class="form-check-input me-1" type="radio" name="product_name" value="{{ item['name'] }}" required>
                            <strong>{{ item['name'] }}</strong> ‚Äî {{ item['description'] }} ({{ item['price'] }} ‚Ç∏, {{ item['stock'] }} —à—Ç.)
                        </label>
                    {% endfor %}
                </div>
                <div class="input-group input-group-lg mt-4">
                    <input type="text" name="user_question" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å..." required>
                    <button class="btn btn-success" type="submit">üí¨ –°–ø—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </form>
        {% else %}
            <div class="card mb-4 animate-fadeIn shadow-lg">
                <div class="card-body">
                    <h4 class="card-title text-dark">{{ matches[0]['name'] }}</h4>
                    <p class="card-text text-dark">{{ matches[0]['description'] }}</p>
                    <p class="card-text text-dark">üíµ –¶–µ–Ω–∞: {{ matches[0]['price'] }} ‚Ç∏</p>
                    <p class="card-text text-dark">üì¶ –í –Ω–∞–ª–∏—á–∏–∏: {{ matches[0]['stock'] }} —à—Ç.</p>
                </div>
            </div>
            <form method="POST" action="/ask_more">
                <input type="hidden" name="product_name" value="{{ matches[0]['name'] }}">
                <div class="input-group input-group-lg">
                    <input type="text" name="user_question" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å..." required>
                    <button class="btn btn-success" type="submit">üí¨ –°–ø—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </form>
        {% endif %}
    </div>
    {% elif product_name and is_search %}
    <div class="card mt-4 border-danger shadow-sm animate-fadeIn">
        <div class="card-body text-danger">
            <h5 class="card-title">‚ùå –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
            <p class="card-text">–ü–æ –∑–∞–ø—Ä–æ—Å—É ¬´<b>{{ product_name }}</b>¬ª –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
        </div>
    </div>
    {% endif %}

    {% if answer %}
    <div id="answerCard" class="card mt-4 shadow-lg animate-fadeIn">
        <div class="card-body">
            <h5 class="card-title mb-3">üí¨ –û—Ç–≤–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞</h5>
            <p class="card-text">{{ answer|safe }}</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –∏–∑ Python –≤ JavaScript
    const productsList =   products | tojson ; // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ

    const productInput = document.getElementById('product_name');
    const dropdown = document.getElementById('autocomplete-dropdown');

    // –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ –ø–æ –≤–≤–µ–¥–µ–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
    productInput.addEventListener('input', function () {
        const value = this.value.toLowerCase();
        dropdown.innerHTML = '';  // –æ—á–∏—â–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        if (value.length > 0) {
            const matches = productsList.filter(p => p.name.toLowerCase().includes(value));
            if (matches.length > 0) {
                dropdown.style.display = 'block';  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                matches.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = product.name;
                    item.onclick = function () {
                        productInput.value = this.textContent;
                        dropdown.style.display = 'none';  // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                    };
                    dropdown.appendChild(item);  // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                });
            } else {
                dropdown.style.display = 'none';  // –°–∫—Ä—ã—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            }
        } else {
            dropdown.style.display = 'none';  // –°–∫—Ä—ã—Ç—å, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
    function startRecognition() {
        const voiceButton = document.getElementById('voiceButton');
        if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
            alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ.");
            return;
        }

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ru-RU';
        recognition.start();

        voiceButton.innerHTML = 'üîÑ –ò–¥–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ...';

        recognition.onresult = event => {
            productInput.value = event.results[0][0].transcript;
            voiceButton.innerHTML = 'üéô –ì–æ–≤–æ—Ä–∏—Ç—å';  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        };

        recognition.onerror = function () {
            voiceButton.innerHTML = '‚ùå –û—à–∏–±–∫–∞';
            setTimeout(() => {
                voiceButton.innerHTML = 'üéô –ì–æ–≤–æ—Ä–∏—Ç—å';
            }, 2000);
        };
    }
</script>

</body>
</html>
